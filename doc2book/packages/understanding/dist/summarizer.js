"use strict";
/**
 * 摘要生成器
 * 生成文档的各种类型摘要
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.Summarizer = void 0;
/**
 * 摘要生成器类
 */
class Summarizer {
    providerManager;
    constructor(providerManager) {
        this.providerManager = providerManager;
    }
    /**
     * 生成摘要
     */
    async summarize(ast, options) {
        const startTime = Date.now();
        try {
            // 提取文本内容
            const textContent = this.extractText(ast.content);
            if (textContent.length < 50) {
                return {
                    success: false,
                    error: '文档内容太短，无法生成摘要',
                    generationTime: Date.now() - startTime,
                };
            }
            const summaryType = options?.type || 'all';
            const result = {
                success: true,
                generationTime: 0,
            };
            // 根据类型生成不同的摘要
            if (summaryType === 'brief' || summaryType === 'all') {
                result.brief = await this.generateBriefSummary(textContent, options);
            }
            if (summaryType === 'standard' || summaryType === 'all') {
                result.standard = await this.generateStandardSummary(textContent, options);
            }
            if (summaryType === 'detailed' || summaryType === 'all') {
                result.detailed = await this.generateDetailedSummary(textContent, options);
            }
            if (summaryType === 'bullets' || summaryType === 'all') {
                result.bulletPoints = await this.generateBulletPoints(textContent, options);
            }
            result.generationTime = Date.now() - startTime;
            return result;
        }
        catch (error) {
            return {
                success: false,
                error: error instanceof Error ? error.message : '生成摘要失败',
                generationTime: Date.now() - startTime,
            };
        }
    }
    /**
     * 生成简短摘要（1-2句）
     */
    async generateBriefSummary(text, options) {
        const prompt = `请用1-2句话概括以下内容的核心要点：

${this.truncateText(text, 5000)}

要求：
- 简洁明了
- 抓住核心
- ${options?.language ? `使用${options.language}` : '使用原文语言'}`;
        const response = await this.providerManager.complete([{ role: 'user', content: prompt }], {
            providerId: options?.providerId,
            temperature: 0.3,
            maxTokens: 200,
        });
        return response.success ? response.content : undefined;
    }
    /**
     * 生成标准摘要（1段）
     */
    async generateStandardSummary(text, options) {
        const maxLength = options?.maxLength || 500;
        const prompt = `请为以下内容生成一段摘要（约${maxLength}字）：

${this.truncateText(text, 8000)}

要求：
- 涵盖主要内容
- 逻辑清晰
- 语言流畅
- ${options?.language ? `使用${options.language}` : '使用原文语言'}`;
        const response = await this.providerManager.complete([{ role: 'user', content: prompt }], {
            providerId: options?.providerId,
            temperature: 0.3,
            maxTokens: Math.ceil(maxLength * 1.5),
        });
        return response.success ? response.content : undefined;
    }
    /**
     * 生成详细摘要（多段）
     */
    async generateDetailedSummary(text, options) {
        const prompt = `请为以下内容生成详细摘要：

${this.truncateText(text, 10000)}

要求：
- 分段组织
- 涵盖所有重要内容
- 保持逻辑结构
- 包含关键细节
- ${options?.language ? `使用${options.language}` : '使用原文语言'}`;
        const response = await this.providerManager.complete([{ role: 'user', content: prompt }], {
            providerId: options?.providerId,
            temperature: 0.3,
            maxTokens: 2000,
        });
        return response.success ? response.content : undefined;
    }
    /**
     * 生成要点列表
     */
    async generateBulletPoints(text, options) {
        const bulletCount = options?.bulletCount || 5;
        const prompt = `请从以下内容中提取${bulletCount}个核心要点：

${this.truncateText(text, 8000)}

要求：
- 每个要点一行
- 以"- "开头
- 简洁明了
- 抓住关键信息
- ${options?.language ? `使用${options.language}` : '使用原文语言'}`;
        const response = await this.providerManager.complete([{ role: 'user', content: prompt }], {
            providerId: options?.providerId,
            temperature: 0.3,
            maxTokens: 1000,
        });
        if (!response.success || !response.content) {
            return undefined;
        }
        // 解析要点
        const lines = response.content.split('\n');
        const bullets = [];
        for (const line of lines) {
            const match = line.match(/^[-*•]\s*(.+)$/);
            if (match) {
                bullets.push(match[1].trim());
            }
        }
        return bullets.length > 0 ? bullets : undefined;
    }
    /**
     * 提取文本内容
     */
    extractText(nodes) {
        const texts = [];
        for (const node of nodes) {
            if (node.text) {
                texts.push(node.text);
            }
            if (node.children) {
                texts.push(this.extractText(node.children));
            }
        }
        return texts.join('\n\n');
    }
    /**
     * 截断文本
     */
    truncateText(text, maxLength) {
        if (text.length <= maxLength) {
            return text;
        }
        return text.substring(0, maxLength) + '\n\n[内容已截断...]';
    }
}
exports.Summarizer = Summarizer;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3VtbWFyaXplci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9zdW1tYXJpemVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQTs7O0dBR0c7OztBQU1IOztHQUVHO0FBQ0gsTUFBYSxVQUFVO0lBQ2IsZUFBZSxDQUFpQjtJQUV4QyxZQUFZLGVBQWdDO1FBQzFDLElBQUksQ0FBQyxlQUFlLEdBQUcsZUFBZSxDQUFBO0lBQ3hDLENBQUM7SUFFRDs7T0FFRztJQUNILEtBQUssQ0FBQyxTQUFTLENBQUMsR0FBZSxFQUFFLE9BQXdCO1FBQ3ZELE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQTtRQUU1QixJQUFJLENBQUM7WUFDSCxTQUFTO1lBQ1QsTUFBTSxXQUFXLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLENBQUE7WUFFakQsSUFBSSxXQUFXLENBQUMsTUFBTSxHQUFHLEVBQUUsRUFBRSxDQUFDO2dCQUM1QixPQUFPO29CQUNMLE9BQU8sRUFBRSxLQUFLO29CQUNkLEtBQUssRUFBRSxlQUFlO29CQUN0QixjQUFjLEVBQUUsSUFBSSxDQUFDLEdBQUcsRUFBRSxHQUFHLFNBQVM7aUJBQ3ZDLENBQUE7WUFDSCxDQUFDO1lBRUQsTUFBTSxXQUFXLEdBQUcsT0FBTyxFQUFFLElBQUksSUFBSSxLQUFLLENBQUE7WUFDMUMsTUFBTSxNQUFNLEdBQWtCO2dCQUM1QixPQUFPLEVBQUUsSUFBSTtnQkFDYixjQUFjLEVBQUUsQ0FBQzthQUNsQixDQUFBO1lBRUQsY0FBYztZQUNkLElBQUksV0FBVyxLQUFLLE9BQU8sSUFBSSxXQUFXLEtBQUssS0FBSyxFQUFFLENBQUM7Z0JBQ3JELE1BQU0sQ0FBQyxLQUFLLEdBQUcsTUFBTSxJQUFJLENBQUMsb0JBQW9CLENBQUMsV0FBVyxFQUFFLE9BQU8sQ0FBQyxDQUFBO1lBQ3RFLENBQUM7WUFFRCxJQUFJLFdBQVcsS0FBSyxVQUFVLElBQUks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QUssQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQTtZQUM3QyxDQUFDO1FBQ0gsQ0FBQztRQUVELE9BQU8sS0FBSyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQTtJQUMzQixDQUFDO0lBRUQ7O09BRUc7SUFDSyxZQUFZLENBQUMsSUFBWSxFQUFFLFNBQWlCO1FBQ2xELElBQUksSUFBSSxDQUFDLE1BQU0sSUFBSSxTQUFTLEVBQUUsQ0FBQztZQUM3QixPQUFPLElBQUksQ0FBQTtRQUNiLENBQUM7UUFDRCxPQUFPLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQyxFQUFFLFNBQVMsQ0FBQyxHQUFHLGdCQUFnQixDQUFBO0lBQ3hELENBQUM7Q0FDRjtBQTlORCxnQ0E4TkMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIOaRmOimgeeUn+aIkOWZqFxuICog55Sf5oiQ5paH5qGj55qE5ZCE56eN57G75Z6L5pGY6KaBXG4gKi9cblxuaW1wb3J0IHR5cGUgeyBVbmlmaWVkQVNULCBDb250ZW50Tm9kZSB9IGZyb20gJ0Bkb2MyYm9vay9zaGFyZWQnXG5pbXBvcnQgdHlwZSB7IFByb3ZpZGVyTWFuYWdlciB9IGZyb20gJ0Bkb2MyYm9vay9wcm92aWRlcnMnXG5pbXBvcnQgdHlwZSB7IFN1bW1hcnlSZXN1bHQsIFN1bW1hcnlPcHRpb25zIH0gZnJvbSAnLi90eXBlcydcblxuLyoqXG4gKiDmkZjopoHnlJ/miJDlmajnsbtcbiAqL1xuZXhwb3J0IGNsYXNzIFN1bW1hcml6ZXIge1xuICBwcml2YXRlIHByb3ZpZGVyTWFuYWdlcjogUHJvdmlkZXJNYW5hZ2VyXG5cbiAgY29uc3RydWN0b3IocHJvdmlkZXJNYW5hZ2VyOiBQcm92aWRlck1hbmFnZXIpIHtcbiAgICB0aGlzLnByb3ZpZGVyTWFuYWdlciA9IHByb3ZpZGVyTWFuYWdlclxuICB9XG5cbiAgLyoqXG4gICAqIOeUn+aIkOaRmOimgVxuICAgKi9cbiAgYXN5bmMgc3VtbWFyaXplKGFzdDogVW5pZmllZEFTVCwgb3B0aW9ucz86IFN1bW1hcnlPcHRpb25zKTogUHJvbWlzZTxTdW1tYXJ5UmVzdWx0PiB7XG4gICAgY29uc3Qgc3RhcnRUaW1lID0gRGF0ZS5ub3coKVxuXG4gICAgdHJ5IHtcbiAgICAgIC8vIOaPkOWPluaWh+acrOWGheWuuVxuICAgICAgY29uc3QgdGV4dENvbnRlbnQgPSB0aGlzLmV4dHJhY3RUZXh0KGFzdC5jb250ZW50KVxuXG4gICAgICBpZiAodGV4dENvbnRlbnQubGVuZ3RoIDwgNTApIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgICBlcnJvcjogJ+aWh+aho+WGheWuueWkquefre+8jOaXoOazleeUn+aIkOaRmOimgScsXG4gICAgICAgICAgZ2VuZXJhdGlvblRpbWU6IERhdGUubm93KCkgLSBzdGFydFRpbWUsXG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgY29uc3Qgc3VtbWFyeVR5cGUgPSBvcHRpb25zPy50eXBlIHx8ICdhbGwnXG4gICAgICBjb25zdCByZXN1bHQ6IFN1bW1hcnlSZXN1bHQgPSB7XG4gICAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICAgIGdlbmVyYXRpb25UaW1lOiAwLFxuICAgICAgfVxuXG4gICAgICAvLyDmoLnmja7nsbvlnovnlJ/miJDkuI3lkIznmoTmkZjopoFcbiAgICAgIGlmIChzdW1tYXJ5VHlwZSA9PT0gJ2JyaWVmJyB8fCBzdW1tYXJ5VHlwZSA9PT0gJ2FsbCcpIHtcbiAgICAgICAgcmVzdWx0LmJyaWVmID0gYXdhaXQgdGhpcy5nZW5lcmF0ZUJyaWVmU3VtbWFyeSh0ZXh0Q29udGVudCwgb3B0aW9ucylcbiAgICAgIH1cblxuICAgICAgaWYgKHN1bW1hcnlUeXBlID09PSAnc3RhbmRhcmQnIHx8IHN1bW1hcnlUeXBlID09PSAnYWxsJykge1xuICAgICAgICByZXN1bHQuc3RhbmRhcmQgPSBhd2FpdCB0aGlzLmdlbmVyYXRlU3RhbmRhcmRTdW1tYXJ5KHRleHRDb250ZW50LCBvcHRpb25zKVxuICAgICAgfVxuXG4gICAgICBpZiAoc3VtbWFyeVR5cGUgPT09ICdkZXRhaWxlZCcgfHwgc3VtbWFyeVR5cGUgPT09ICdhbGwnKSB7XG4gICAgICAgIHJlc3VsdC5kZXRhaWxlZCA9IGF3YWl0IHRoaXMuZ2VuZXJhdGVEZXRhaWxlZFN1bW1hcnkodGV4dENvbnRlbnQsIG9wdGlvbnMpXG4gICAgICB9XG5cbiAgICAgIGlmIChzdW1tYXJ5VHlwZSA9PT0gJ2J1bGxldHMnIHx8IHN1bW1hcnlUeXBlID09PSAnYWxsJykge1xuICAgICAgICByZXN1bHQuYnVsbGV0UG9pbnRzID0gYXdhaXQgdGhpcy5nZW5lcmF0ZUJ1bGxldFBvaW50cyh0ZXh0Q29udGVudCwgb3B0aW9ucylcbiAgICAgIH1cblxuICAgICAgcmVzdWx0LmdlbmVyYXRpb25UaW1lID0gRGF0ZS5ub3coKSAtIHN0YXJ0VGltZVxuICAgICAgcmV0dXJuIHJlc3VsdFxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgZXJyb3I6IGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogJ+eUn+aIkOaRmOimgeWksei0pScsXG4gICAgICAgIGdlbmVyYXRpb25UaW1lOiBEYXRlLm5vdygpIC0gc3RhcnRUaW1lLFxuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiDnlJ/miJDnroDnn63mkZjopoHvvIgxLTLlj6XvvIlcbiAgICovXG4gIHByaXZhdGUgYXN5bmMgZ2VuZXJhdGVCcmllZlN1bW1hcnkoXG4gICAgdGV4dDogc3RyaW5nLFxuICAgIG9wdGlvbnM/OiBTdW1tYXJ5T3B0aW9uc1xuICApOiBQcm9taXNlPHN0cmluZyB8IHVuZGVmaW5lZD4ge1xuICAgIGNvbnN0IHByb21wdCA9IGDor7fnlKgxLTLlj6Xor53mpoLmi6zku6XkuIvlhoXlrrnnmoTmoLjlv4PopoHngrnvvJpcblxuJHt0aGlzLnRydW5jYXRlVGV4dCh0ZXh0LCA1MDAwKX1cblxu6KaB5rGC77yaXG4tIOeugOa0geaYjuS6hlxuLSDmipPkvY/moLjlv4Ncbi0gJHtvcHRpb25zPy5sYW5ndWFnZSA/IGDkvb/nlKgke29wdGlvbnMubGFuZ3VhZ2V9YCA6ICfkvb/nlKjljp/mlofor63oqIAnfWBcblxuICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgdGhpcy5wcm92aWRlck1hbmFnZXIuY29tcGxldGUoXG4gICAgICBbeyByb2xlOiAndXNlcicsIGNvbnRlbnQ6IHByb21wdCB9XSxcbiAgICAgIHtcbiAgICAgICAgcHJvdmlkZXJJZDogb3B0aW9ucz8ucHJvdmlkZXJJZCxcbiAgICAgICAgdGVtcGVyYXR1cmU6IDAuMyxcbiAgICAgICAgbWF4VG9rZW5zOiAyMDAsXG4gICAgICB9XG4gICAgKVxuXG4gICAgcmV0dXJuIHJlc3BvbnNlLnN1Y2Nlc3MgPyByZXNwb25zZS5jb250ZW50IDogdW5kZWZpbmVkXG4gIH1cblxuICAvKipcbiAgICog55Sf5oiQ5qCH5YeG5pGY6KaB77yIMeaute+8iVxuICAgKi9cbiAgcHJpdmF0ZSBhc3luYyBnZW5lcmF0ZVN0YW5kYXJkU3VtbWFyeShcbiAgICB0ZXh0OiBzdHJpbmcsXG4gICAgb3B0aW9ucz86IFN1bW1hcnlPcHRpb25zXG4gICk6IFByb21pc2U8c3RyaW5nIHwgdW5kZWZpbmVkPiB7XG4gICAgY29uc3QgbWF4TGVuZ3RoID0gb3B0aW9ucz8ubWF4TGVuZ3RoIHx8IDUwMFxuXG4gICAgY29uc3QgcHJvbXB0ID0gYOivt+S4uuS7peS4i+WGheWuueeUn+aIkOS4gOauteaRmOimge+8iOe6piR7bWF4TGVuZ3RofeWtl++8ie+8mlxuXG4ke3RoaXMudHJ1bmNhdGVUZXh0KHRleHQsIDgwMDApfVxuXG7opoHmsYLvvJpcbi0g5ra155uW5Li76KaB5YaF5a65XG4tIOmAu+i+kea4heaZsFxuLSDor63oqIDmtYHnlYVcbi0gJHtvcHRpb25zPy5sYW5ndWFnZSA/IGDkvb/nlKgke29wdGlvbnMubGFuZ3VhZ2V9YCA6ICfkvb/nlKjljp/mlofor63oqIAnfWBcblxuICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgdGhpcy5wcm92aWRlck1hbmFnZXIuY29tcGxldGUoXG4gICAgICBbeyByb2xlOiAndXNlcicsIGNvbnRlbnQ6IHByb21wdCB9XSxcbiAgICAgIHtcbiAgICAgICAgcHJvdmlkZXJJZDogb3B0aW9ucz8ucHJvdmlkZXJJZCxcbiAgICAgICAgdGVtcGVyYXR1cmU6IDAuMyxcbiAgICAgICAgbWF4VG9rZW5zOiBNYXRoLmNlaWwobWF4TGVuZ3RoICogMS41KSxcbiAgICAgIH1cbiAgICApXG5cbiAgICByZXR1cm4gcmVzcG9uc2Uuc3VjY2VzcyA/IHJlc3BvbnNlLmNvbnRlbnQgOiB1bmRlZmluZWRcbiAgfVxuXG4gIC8qKlxuICAgKiDnlJ/miJDor6bnu4bmkZjopoHvvIjlpJrmrrXvvIlcbiAgICovXG4gIHByaXZhdGUgYXN5bmMgZ2VuZXJhdGVEZXRhaWxlZFN1bW1hcnkoXG4gICAgdGV4dDogc3RyaW5nLFxuICAgIG9wdGlvbnM/OiBTdW1tYXJ5T3B0aW9uc1xuICApOiBQcm9taXNlPHN0cmluZyB8IHVuZGVmaW5lZD4ge1xuICAgIGNvbnN0IHByb21wdCA9IGDor7fkuLrku6XkuIvlhoXlrrnnlJ/miJDor6bnu4bmkZjopoHvvJpcblxuJHt0aGlzLnRydW5jYXRlVGV4dCh0ZXh0LCAxMDAwMCl9XG5cbuimgeaxgu+8mlxuLSDliIbmrrXnu4Tnu4dcbi0g5ra155uW5omA5pyJ6YeN6KaB5YaF5a65XG4tIOS/neaMgemAu+i+kee7k+aehFxuLSDljIXlkKvlhbPplK7nu4boioJcbi0gJHtvcHRpb25zPy5sYW5ndWFnZSA/IGDkvb/nlKgke29wdGlvbnMubGFuZ3VhZ2V9YCA6ICfkvb/nlKjljp/mlofor63oqIAnfWBcblxuICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgdGhpcy5wcm92aWRlck1hbmFnZXIuY29tcGxldGUoXG4gICAgICBbeyByb2xlOiAndXNlcicsIGNvbnRlbnQ6IHByb21wdCB9XSxcbiAgICAgIHtcbiAgICAgICAgcHJvdmlkZXJJZDogb3B0aW9ucz8ucHJvdmlkZXJJZCxcbiAgICAgICAgdGVtcGVyYXR1cmU6IDAuMyxcbiAgICAgICAgbWF4VG9rZW5zOiAyMDAwLFxuICAgICAgfVxuICAgIClcblxuICAgIHJldHVybiByZXNwb25zZS5zdWNjZXNzID8gcmVzcG9uc2UuY29udGVudCA6IHVuZGVmaW5lZFxuICB9XG5cbiAgLyoqXG4gICAqIOeUn+aIkOimgeeCueWIl+ihqFxuICAgKi9cbiAgcHJpdmF0ZSBhc3luYyBnZW5lcmF0ZUJ1bGxldFBvaW50cyhcbiAgICB0ZXh0OiBzdHJpbmcsXG4gICAgb3B0aW9ucz86IFN1bW1hcnlPcHRpb25zXG4gICk6IFByb21pc2U8c3RyaW5nW10gfCB1bmRlZmluZWQ+IHtcbiAgICBjb25zdCBidWxsZXRDb3VudCA9IG9wdGlvbnM/LmJ1bGxldENvdW50IHx8IDVcblxuICAgIGNvbnN0IHByb21wdCA9IGDor7fku47ku6XkuIvlhoXlrrnkuK3mj5Dlj5Yke2J1bGxldENvdW50feS4quaguOW/g+imgeeCue+8mlxuXG4ke3RoaXMudHJ1bmNhdGVUZXh0KHRleHQsIDgwMDApfVxuXG7opoHmsYLvvJpcbi0g5q+P5Liq6KaB54K55LiA6KGMXG4tIOS7pVwiLSBcIuW8gOWktFxuLSDnroDmtIHmmI7kuoZcbi0g5oqT5L2P5YWz6ZSu5L+h5oGvXG4tICR7b3B0aW9ucz8ubGFuZ3VhZ2UgPyBg5L2/55SoJHtvcHRpb25zLmxhbmd1YWdlfWAgOiAn5L2/55So5Y6f5paH6K+t6KiAJ31gXG5cbiAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHRoaXMucHJvdmlkZXJNYW5hZ2VyLmNvbXBsZXRlKFxuICAgICAgW3sgcm9sZTogJ3VzZXInLCBjb250ZW50OiBwcm9tcHQgfV0sXG4gICAgICB7XG4gICAgICAgIHByb3ZpZGVySWQ6IG9wdGlvbnM/LnByb3ZpZGVySWQsXG4gICAgICAgIHRlbXBlcmF0dXJlOiAwLjMsXG4gICAgICAgIG1heFRva2VuczogMTAwMCxcbiAgICAgIH1cbiAgICApXG5cbiAgICBpZiAoIXJlc3BvbnNlLnN1Y2Nlc3MgfHwgIXJlc3BvbnNlLmNvbnRlbnQpIHtcbiAgICAgIHJldHVybiB1bmRlZmluZWRcbiAgICB9XG5cbiAgICAvLyDop6PmnpDopoHngrlcbiAgICBjb25zdCBsaW5lcyA9IHJlc3BvbnNlLmNvbnRlbnQuc3BsaXQoJ1xcbicpXG4gICAgY29uc3QgYnVsbGV0czogc3RyaW5nW10gPSBbXVxuXG4gICAgZm9yIChjb25zdCBsaW5lIG9mIGxpbmVzKSB7XG4gICAgICBjb25zdCBtYXRjaCA9IGxpbmUubWF0Y2goL15bLSrigKJdXFxzKiguKykkLylcbiAgICAgIGlmIChtYXRjaCkge1xuICAgICAgICBidWxsZXRzLnB1c2gobWF0Y2hbMV0udHJpbSgpKVxuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBidWxsZXRzLmxlbmd0aCA+IDAgPyBidWxsZXRzIDogdW5kZWZpbmVkXG4gIH1cblxuICAvKipcbiAgICog5o+Q5Y+W5paH5pys5YaF5a65XG4gICAqL1xuICBwcml2YXRlIGV4dHJhY3RUZXh0KG5vZGVzOiBDb250ZW50Tm9kZVtdKTogc3RyaW5nIHtcbiAgICBjb25zdCB0ZXh0czogc3RyaW5nW10gPSBbXVxuXG4gICAgZm9yIChjb25zdCBub2RlIG9mIG5vZGVzKSB7XG4gICAgICBpZiAobm9kZS50ZXh0KSB7XG4gICAgICAgIHRleHRzLnB1c2gobm9kZS50ZXh0KVxuICAgICAgfVxuICAgICAgaWYgKG5vZGUuY2hpbGRyZW4pIHtcbiAgICAgICAgdGV4dHMucHVzaCh0aGlzLmV4dHJhY3RUZXh0KG5vZGUuY2hpbGRyZW4pKVxuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiB0ZXh0cy5qb2luKCdcXG5cXG4nKVxuICB9XG5cbiAgLyoqXG4gICAqIOaIquaWreaWh+acrFxuICAgKi9cbiAgcHJpdmF0ZSB0cnVuY2F0ZVRleHQodGV4dDogc3RyaW5nLCBtYXhMZW5ndGg6IG51bWJlcik6IHN0cmluZyB7XG4gICAgaWYgKHRleHQubGVuZ3RoIDw9IG1heExlbmd0aCkge1xuICAgICAgcmV0dXJuIHRleHRcbiAgICB9XG4gICAgcmV0dXJuIHRleHQuc3Vic3RyaW5nKDAsIG1heExlbmd0aCkgKyAnXFxuXFxuW+WGheWuueW3suaIquaWrS4uLl0nXG4gIH1cbn1cbiJdfQ==