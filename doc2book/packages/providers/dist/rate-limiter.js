"use strict";
/**
 * 速率限制器
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.RateLimiter = void 0;
/**
 * 速率限制器类
 */
class RateLimiter {
    requestsPerMinute;
    tokensPerMinute;
    maxConcurrent;
    requestCount = 0;
    tokenCount = 0;
    concurrentCount = 0;
    windowStart = Date.now();
    constructor(config) {
        this.requestsPerMinute = config.requestsPerMinute;
        this.tokensPerMinute = config.tokensPerMinute;
        this.maxConcurrent = config.maxConcurrent || 10;
    }
    /**
     * 检查是否可以发送请求
     */
    canRequest(estimatedTokens = 0) {
        this.resetWindowIfNeeded();
        // 检查并发限制
        if (this.concurrentCount >= this.maxConcurrent) {
            return false;
        }
        // 检查请求数限制
        if (this.requestCount >= this.requestsPerMinute) {
            return false;
        }
        // 检查 token 限制
        if (this.tokenCount + estimatedTokens > this.tokensPerMinute) {
            return false;
        }
        return true;
    }
    /**
     * 等待直到可以发送请求
     */
    async waitForSlot(estimatedTokens = 0) {
        while (!this.canRequest(estimatedTokens)) {
            const waitTime = this.getWaitTime();
            await this.sleep(waitTime);
            this.resetWindowIfNeeded();
        }
    }
    /**
     * 记录请求开始
     */
    startRequest() {
        this.resetWindowIfNeeded();
        this.requestCount++;
        this.concurrentCount++;
    }
    /**
     * 记录请求结束
     */
    endRequest(tokensUsed = 0) {
        this.concurrentCount = Math.max(0, this.concurrentCount - 1);
        this.tokenCount += tokensUsed;
    }
    /**
     * 获取当前状态
     */
    getStatus() {
        this.resetWindowIfNeeded();
        return {
            remainingRequests: Math.max(0, this.requestsPerMinute - this.requestCount),
            remainingTokens: Math.max(0, this.tokensPerMinute - this.tokenCount),
            resetTime: new Date(this.windowStart + 60000),
            isLimited: !this.canRequest(),
        };
    }
    /**
     * 获取等待时间（毫秒）
     */
    getWaitTime() {
        const elapsed = Date.now() - this.windowStart;
        const remaining = 60000 - elapsed;
        if (remaining <= 0) {
            return 0;
        }
        // 如果是并发限制，等待较短时间
        if (this.concurrentCount >= this.maxConcurrent) {
            return 100;
        }
        // 否则等待到窗口重置
        return remaining;
    }
    /**
     * 如果需要，重置时间窗口
     */
    resetWindowIfNeeded() {
        const now = Date.now();
        if (now - this.windowStart >= 60000) {
            this.windowStart = now;
            this.requestCount = 0;
            this.tokenCount = 0;
        }
    }
    /**
     * 睡眠指定时间
     */
    sleep(ms) {
        return new Promise((resolve) => setTimeout(resolve, ms));
    }
    /**
     * 重置限制器
     */
    reset() {
        this.windowStart = Date.now();
        this.requestCount = 0;
        this.tokenCount = 0;
        this.concurrentCount = 0;
    }
}
exports.RateLimiter = RateLimiter;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmF0ZS1saW1pdGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL3JhdGUtbGltaXRlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUE7O0dBRUc7OztBQUlIOztHQUVHO0FBQ0gsTUFBYSxXQUFXO0lBQ2QsaUJBQWlCLENBQVE7SUFDekIsZUFBZSxDQUFRO0lBQ3ZCLGFBQWEsQ0FBUTtJQUVyQixZQUFZLEdBQVcsQ0FBQyxDQUFBO0lBQ3hCLFVBQVUsR0FBVyxDQUFDLENBQUE7SUFDdEIsZUFBZSxHQUFXLENBQUMsQ0FBQTtJQUMzQixXQUFXLEdBQVcsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFBO0lBRXhDLFlBQVksTUFBdUI7UUFDakMsSUFBSSxDQUFDLGlCQUFpQixHQUFHLE1BQU0sQ0FBQyxpQkFBaUIsQ0FBQTtRQUNqRCxJQUFJLENBQUMsZUFBZSxHQUFHLE1BQU0sQ0FBQyxlQUFlLENBQUE7UUFDN0MsSUFBSSxDQUFDLGFBQWEsR0FBRyxNQUFNLENBQUMsYUFBYSxJQUFJLEVBQUUsQ0FBQTtJQUNqRCxDQUFDO0lBRUQ7O09BRUc7SUFDSCxVQUFVLENBQUMsa0JBQTBCLENBQUM7UUFDcEMsSUFBSSxDQUFDLG1CQUFtQixFQUFFLENBQUE7UUFFMUIsU0FBUztRQUNULElBQUksSUFBSSxDQUFDLGVBQWUsSUFBSSxJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7WUFDL0MsT0FBTyxLQUFLLENBQUE7UUFDZCxDQUFDO1FBRUQsVUFBVTtRQUNWLElBQUksSUFBSSxDQUFDLFlBQVksSUFBSSxJQUFJLENBQUMsaUJBQWlCLEVBQUUsQ0FBQztZQUNoRCxPQUFPLEtBQUssQ0FBQTtRQUNkLENBQUM7UUFFRCxjQUFjO1FBQ2QsSUFBSSxJQUFJLENBQUMsVUFBVSxHQUFHLGVBQWUsR0FBRyxJQUFJLENBQUMsZUFBZSxFQUFFLENBQUM7WUFDN0QsT0FBTyxLQUFLLENBQUE7UUFDZCxDQUFDO1FBRUQsT0FBTyxJQUFJLENBQUE7SUFDYixD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QWUsR0FBRyxDQUFDLENBQUE7SUFDMUIsQ0FBQztDQUNGO0FBbElELGtDQWtJQyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICog6YCf546H6ZmQ5Yi25ZmoXG4gKi9cblxuaW1wb3J0IHR5cGUgeyBSYXRlTGltaXRDb25maWcsIFJhdGVMaW1pdFN0YXR1cyB9IGZyb20gJy4vdHlwZXMnXG5cbi8qKlxuICog6YCf546H6ZmQ5Yi25Zmo57G7XG4gKi9cbmV4cG9ydCBjbGFzcyBSYXRlTGltaXRlciB7XG4gIHByaXZhdGUgcmVxdWVzdHNQZXJNaW51dGU6IG51bWJlclxuICBwcml2YXRlIHRva2Vuc1Blck1pbnV0ZTogbnVtYmVyXG4gIHByaXZhdGUgbWF4Q29uY3VycmVudDogbnVtYmVyXG5cbiAgcHJpdmF0ZSByZXF1ZXN0Q291bnQ6IG51bWJlciA9IDBcbiAgcHJpdmF0ZSB0b2tlbkNvdW50OiBudW1iZXIgPSAwXG4gIHByaXZhdGUgY29uY3VycmVudENvdW50OiBudW1iZXIgPSAwXG4gIHByaXZhdGUgd2luZG93U3RhcnQ6IG51bWJlciA9IERhdGUubm93KClcblxuICBjb25zdHJ1Y3Rvcihjb25maWc6IFJhdGVMaW1pdENvbmZpZykge1xuICAgIHRoaXMucmVxdWVzdHNQZXJNaW51dGUgPSBjb25maWcucmVxdWVzdHNQZXJNaW51dGVcbiAgICB0aGlzLnRva2Vuc1Blck1pbnV0ZSA9IGNvbmZpZy50b2tlbnNQZXJNaW51dGVcbiAgICB0aGlzLm1heENvbmN1cnJlbnQgPSBjb25maWcubWF4Q29uY3VycmVudCB8fCAxMFxuICB9XG5cbiAgLyoqXG4gICAqIOajgOafpeaYr+WQpuWPr+S7peWPkemAgeivt+axglxuICAgKi9cbiAgY2FuUmVxdWVzdChlc3RpbWF0ZWRUb2tlbnM6IG51bWJlciA9IDApOiBib29sZWFuIHtcbiAgICB0aGlzLnJlc2V0V2luZG93SWZOZWVkZWQoKVxuXG4gICAgLy8g5qOA5p+l5bm25Y+R6ZmQ5Yi2XG4gICAgaWYgKHRoaXMuY29uY3VycmVudENvdW50ID49IHRoaXMubWF4Q29uY3VycmVudCkge1xuICAgICAgcmV0dXJuIGZhbHNlXG4gICAgfVxuXG4gICAgLy8g5qOA5p+l6K+35rGC5pWw6ZmQ5Yi2XG4gICAgaWYgKHRoaXMucmVxdWVzdENvdW50ID49IHRoaXMucmVxdWVzdHNQZXJNaW51dGUpIHtcbiAgICAgIHJldHVybiBmYWxzZVxuICAgIH1cblxuICAgIC8vIOajgOafpSB0b2tlbiDpmZDliLZcbiAgICBpZiAodGhpcy50b2tlbkNvdW50ICsgZXN0aW1hdGVkVG9rZW5zID4gdGhpcy50b2tlbnNQZXJNaW51dGUpIHtcbiAgICAgIHJldHVybiBmYWxzZVxuICAgIH1cblxuICAgIHJldHVybiB0cnVlXG4gIH1cblxuICAvKipcbiAgICog562J5b6F55u05Yiw5Y+v5Lul5Y+R6YCB6K+35rGCXG4gICAqL1xuICBhc3luYyB3YWl0Rm9yU2xvdChlc3RpbWF0ZWRUb2tlbnM6IG51bWJlciA9IDApOiBQcm9taXNlPHZvaWQ+IHtcbiAgICB3aGlsZSAoIXRoaXMuY2FuUmVxdWVzdChlc3RpbWF0ZWRUb2tlbnMpKSB7XG4gICAgICBjb25zdCB3YWl0VGltZSA9IHRoaXMuZ2V0V2FpdFRpbWUoKVxuICAgICAgYXdhaXQgdGhpcy5zbGVlcCh3YWl0VGltZSlcbiAgICAgIHRoaXMucmVzZXRXaW5kb3dJZk5lZWRlZCgpXG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIOiusOW9leivt+axguW8gOWni1xuICAgKi9cbiAgc3RhcnRSZXF1ZXN0KCk6IHZvaWQge1xuICAgIHRoaXMucmVzZXRXaW5kb3dJZk5lZWRlZCgpXG4gICAgdGhpcy5yZXF1ZXN0Q291bnQrK1xuICAgIHRoaXMuY29uY3VycmVudENvdW50KytcbiAgfVxuXG4gIC8qKlxuICAgKiDorrDlvZXor7fmsYLnu5PmnZ9cbiAgICovXG4gIGVuZFJlcXVlc3QodG9rZW5zVXNlZDogbnVtYmVyID0gMCk6IHZvaWQge1xuICAgIHRoaXMuY29uY3VycmVudENvdW50ID0gTWF0aC5tYXgoMCwgdGhpcy5jb25jdXJyZW50Q291bnQgLSAxKVxuICAgIHRoaXMudG9rZW5Db3VudCArPSB0b2tlbnNVc2VkXG4gIH1cblxuICAvKipcbiAgICog6I635Y+W5b2T5YmN54q25oCBXG4gICAqL1xuICBnZXRTdGF0dXMoKTogUmF0ZUxpbWl0U3RhdHVzIHtcbiAgICB0aGlzLnJlc2V0V2luZG93SWZOZWVkZWQoKVxuXG4gICAgcmV0dXJuIHtcbiAgICAgIHJlbWFpbmluZ1JlcXVlc3RzOiBNYXRoLm1heCgwLCB0aGlzLnJlcXVlc3RzUGVyTWludXRlIC0gdGhpcy5yZXF1ZXN0Q291bnQpLFxuICAgICAgcmVtYWluaW5nVG9rZW5zOiBNYXRoLm1heCgwLCB0aGlzLnRva2Vuc1Blck1pbnV0ZSAtIHRoaXMudG9rZW5Db3VudCksXG4gICAgICByZXNldFRpbWU6IG5ldyBEYXRlKHRoaXMud2luZG93U3RhcnQgKyA2MDAwMCksXG4gICAgICBpc0xpbWl0ZWQ6ICF0aGlzLmNhblJlcXVlc3QoKSxcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICog6I635Y+W562J5b6F5pe26Ze077yI5q+r56eS77yJXG4gICAqL1xuICBwcml2YXRlIGdldFdhaXRUaW1lKCk6IG51bWJlciB7XG4gICAgY29uc3QgZWxhcHNlZCA9IERhdGUubm93KCkgLSB0aGlzLndpbmRvd1N0YXJ0XG4gICAgY29uc3QgcmVtYWluaW5nID0gNjAwMDAgLSBlbGFwc2VkXG5cbiAgICBpZiAocmVtYWluaW5nIDw9IDApIHtcbiAgICAgIHJldHVybiAwXG4gICAgfVxuXG4gICAgLy8g5aaC5p6c5piv5bm25Y+R6ZmQ5Yi277yM562J5b6F6L6D55+t5pe26Ze0XG4gICAgaWYgKHRoaXMuY29uY3VycmVudENvdW50ID49IHRoaXMubWF4Q29uY3VycmVudCkge1xuICAgICAgcmV0dXJuIDEwMFxuICAgIH1cblxuICAgIC8vIOWQpuWImeetieW+heWIsOeql+WPo+mHjee9rlxuICAgIHJldHVybiByZW1haW5pbmdcbiAgfVxuXG4gIC8qKlxuICAgKiDlpoLmnpzpnIDopoHvvIzph43nva7ml7bpl7Tnqpflj6NcbiAgICovXG4gIHByaXZhdGUgcmVzZXRXaW5kb3dJZk5lZWRlZCgpOiB2b2lkIHtcbiAgICBjb25zdCBub3cgPSBEYXRlLm5vdygpXG4gICAgaWYgKG5vdyAtIHRoaXMud2luZG93U3RhcnQgPj0gNjAwMDApIHtcbiAgICAgIHRoaXMud2luZG93U3RhcnQgPSBub3dcbiAgICAgIHRoaXMucmVxdWVzdENvdW50ID0gMFxuICAgICAgdGhpcy50b2tlbkNvdW50ID0gMFxuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiDnnaHnnKDmjIflrprml7bpl7RcbiAgICovXG4gIHByaXZhdGUgc2xlZXAobXM6IG51bWJlcik6IFByb21pc2U8dm9pZD4ge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4gc2V0VGltZW91dChyZXNvbHZlLCBtcykpXG4gIH1cblxuICAvKipcbiAgICog6YeN572u6ZmQ5Yi25ZmoXG4gICAqL1xuICByZXNldCgpOiB2b2lkIHtcbiAgICB0aGlzLndpbmRvd1N0YXJ0ID0gRGF0ZS5ub3coKVxuICAgIHRoaXMucmVxdWVzdENvdW50ID0gMFxuICAgIHRoaXMudG9rZW5Db3VudCA9IDBcbiAgICB0aGlzLmNvbmN1cnJlbnRDb3VudCA9IDBcbiAgfVxufVxuIl19